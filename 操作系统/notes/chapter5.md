# Chapter 5

设备管理功能
设备分配
按照一定的算法把I/O设备、及其相应的设备控制器和通道分配给用户（进程），对未能分配到设备的进程，将其插入等待队列中。
缓冲区管理
为解决CPU与I/O之间速度不匹配的矛盾，在它们之间配置了缓冲区。设备管理程序需要负责管理缓冲区的建立、分配和释放。
实现物理I/O设备的操作
对具有通道的系统，生成专门的通道指令启动通道，对指定设备进行I/O操作，并能响应通道的中断请求。
对未设置通道的系统，直接驱动设备进行I/O操作。

I/O设备分类
按照I/O操作特性
输入型设备、输出型设备、存储型设备。
按照I/O信息交换的单位
字符设备、块设备。
输入型外围设备和输出型外围设备一般为字符设备，与内存进行信息交换的单位是字节。
存储型外围设备一般为块设备
顺序存取存储设备：只有当前面的存储物理块被存取以后，才能存取后面的物理块，如磁带。
直接存取存储设备：对任何一个物理块存取不必进行事先顺序搜索，如磁盘。存取任何一个物理块所需的时间几乎不依赖于此信息的位置。

按照I/O控制器功能的强弱，以及和CPU间联系方式的不同，对I/O设备的控制方式分类：
轮询方式
中断方式
DMA方式
通道方式
主要差别在于：中央处理器和外围设备并行工作的方式不同，并行工作的程度不同。

轮询方式
程序I/O（Programmed I/O）方式或忙-等待方式。
早期的计算机系统中，没有中断机构，处理机对I/O设备直接进行控制。
使用查询指令测试设备控制器的忙闲状态位，决定内存和设备是否能交换数据。
轮询方式使用：
1)查询指令：查询设备是否就绪；
2)读/写指令：当设备就绪时，执行数据交换；
3)转移指令：当设备未就绪时，执行转移指令转向查询指令继续查询。
特点：
在外设进行数据处理时，CPU只能等待(忙等待）, 消耗大量处理机时间；
处理机与设备串行工作；
管理简单，可在要求不高的场合被采用。

中断方式
中断方式要求CPU与设备控制器及设备之间有中断请求线，控制器的状态寄存器有相应中断允许位。
 CPU与设备间数据传输过程：
1)进程发出启动I/O指令，CPU加载控制信息到设备控制器的寄存器，然后，进程继续执行或放弃CPU等待设备操作完成；
2)设备控制器检查状态寄存器，按照I/O指令要求，执行相应I/O操作，一旦传输完成，设备控制器通过中断请求线发出I/O中断信号；
3)CPU收到并响应I/O中断后，转向处理该设备的I/O中断例程执行；
4)中断处理例程执行数据读取操作，将I/O缓冲寄存器的内容写入内存，操作结束后退出中断处理程序，返回中断前的执行状态；
5)进程调度程序在适当时刻恢复得到数据的进程执行。
优点：在外设进行数据处理时，CPU不必等待，可以继续执行该程序或其他程序。
缺点：每次I/O都要CPU的干预，CPU每次处理的数据量少（通常不超过几个字节），只适于数据传输率较低的设备。

DMA方式
中断驱动方式以字（节）为单位进行数据传送，每完成一个字（节）的传送，控制器产生一次中断。系统需占用CPU进行现场的保存和和恢复。特别是高速直接存储设备的出现，中断处理开销过大，CPU利用率急剧下降。
如果I/O设备能直接与内存交换数据而不占用CPU，利用率还可提高，由此产生了直接存储器存取DMA方式。
DMA方式需以下设施：
 (1)内存地址寄存器  
 (2)字计数器
 (3)数据缓冲寄存器或数据缓冲区  
 (4)设备地址寄存器  
 (5)中断机制和控制逻辑
DMA控制器组成
DMA控制器与块设备的接口
I/O控制逻辑
主机与DMA控制器的接口
命令/状态寄存器CR：接收从CPU发来的I/O命令或有关的控制信息，或设备的状态。
内存地址寄存器MAR：存放数据从设备传到内存的目的地址，或由内存到设备的内存源地址。
数据寄存器DR：暂存设备和内存间交换的数据。
数据计数器DC：存放本次CPU要读/写的字（节）数
DMA工作过程
(1)CPU通过设置DMA控制器实现DMA编程，启动磁盘控制器并测试设备。
(2)DMA控制器向磁盘控制器发出读请求，并将内存地址放在地址总线上；
(3)磁盘控制器将字节传送到内存指定单元；
(4)磁盘控制器向DMA控制器发送应答；DMA控制器将内部地址寄存器加1同时将计数器减1；
(5)重复(2)-(4)，当计数器为0时，DMA控制器向CPU发出中断信号。
DMA特点
DMA与内存间采用字传送，DMA与设备间可能是字位或字节传送，所以，DMA中还要设置数据移位寄存器、字节计数器等硬件逻辑。
DMA设有中断机制和DMA传输控制机制，若出现DMA与CPU同时经总线访问内存，CPU总把总线占有权让给DMA(称“周期窃用”)，让设备和内存之间交换数据，不再需要CPU干预，减轻CPU的负担，每次传送数据时，不必进入中断系统，能进一步提高CPU资源的利用率。
优点：CPU只需干预I/O操作的开始和结束，而其中的一批数据读写无需CPU控制，适于高速设备。
DMA方式与中断方式比较
数据传输的基本单位是一个连续的数据块。
 内存与设备之间直接数据传送，不用CPU的干预。
 仅在传送一个或多个数据块的开始和结束时，才需 CPU干预，整块数据的传送是在控制器的控制下完成的。
DMA方式较之中断驱动方式，减少了CPU对 I/O控制的干预，进一步提高了CPU与I/O设备的并发程度

通道方式
通道：是计算机系统中专门用于I/O的处理机。
通道程序
通道程序由一系列通道指令（或称为通道命令）构成。
通道指令与一般的机器指令不同，每条指令中包含的信息较多，包括操作码、内存地址、计数（读或写数据的字节数）、通道程序结束位P和记录结束标志R。
通道通过执行通道程序，与设备控制器共同实现对I/O设备的控制。
采用通道后的I/O操作过程：
用户执行I/O请求时，通过访管指令进入管理程序，由CPU通过管理程序组织一个通道程序，并启动通道。
通道执行CPU为它组织的通道程序，完成指定的数据输入输出工作。此时，CPU可执行其他任务并与通道并行工作。
通道程序结束后向CPU发中断请求。CPU响应这个中断请求后，调用管理程序对中断请求进行处理。
通道类型：
由于外围设备的种类较多，且其传输速率相差很大，所以通道也具有多种类型。根据信息交换方式，可以把通道分成以下三种类型。

1. 字节多路通道（Byte Multiplexor Channel）
以字节为单位传送数据；
通常含有多个（8，16，32）非分配型子通道，每一个子通道连接一台I/O设备。这些子通道按时间片轮转方式共享主通道。一个子通道完成一个字节的传送后，立即让出字节多路通道（主通道），给另一个子通道使用。
适用于连接低速或中速设备，如打印机、终端等。
2. 数组选择通道（Block Selector Channel）
以块（数组）为单位进行数据传输；
可以连接多台I/O设备，只有一个分配型子通道，在一段时间内只能执行一道通道程序、控制一台设备进行数据传送。即当某台设备一旦占用了该通道，就被它独占，直至该设备传送完毕释放该通道为止。
适于连接高速设备（如磁盘机、磁带机），但这种通道利用率较低。
3. 数组多路通道（Block Multiplexor Channel）
以块（数组）为单位进行数据传输；
具有多个非分配型子通道，可以连接多台高、中速的外围设备；
结合了数组选择通道的高传输速率和字节多路通道的分时并行操作优点；
具有数据传输速率高和分时操作不同设备的优点，能获得令人满意的通道利用率。

设备控制器是CPU和设备之间的接口，负责接收从CPU发来的命令，控制I/O设备操作，实现内存和设备之间的数据传输。
设备控制器是一个可编址设备，当它连接多台设备时，则应具有多个设备地址
设备控制器主要功能：
接收和识别CPU或通道发来的命令
实现数据交换,包括设备和控制器间的数据传输
发现和记录设备及自身的状态信息，供CPU处理
设备地址识别
设备控制器组成
命令寄存器及译码器
数据寄存器
状态寄存器
地址译码器

I/O软件总体设计目标:
高效率。
通用性。
 I/O软件总体设计要考虑的问题：
设备无关性：程序与具体物理设备无关。
出错处理：屏蔽错误，不让高层软件感知。
同步/异步传输：支持同步（阻塞）和异步（中断驱动）两种工作方式。
缓冲技术：数据处理速率不匹配，数据处理大小不一致。
独占性外围设备和共享性外围设备：分配和共享。

独立于设备的I/O软件
设备无关软件完成的功能：
提高设备驱动程序统一接口：方便添加设备驱动程序。
设备命名和设备保护：所有设备抽象为文件，用设备文件来表示设备。
提供独立于设备的块大小：隐藏不同设备的物理数据块大小的差异，向高层软件提供大小统一的逻辑数据块。
缓冲区管理：建立内核缓冲区、数据复制。
块设备的存储分配：实现块设备共享。
独占性外围设备的分配和回收：由系统进行统一的分配和回收处理。
错误报告：发现错误、就近逐层处理错误、提示错误

用户空间的I/O软件
小部分I/O系统软件放在用户应用层
库函数（与应用程序链接）
假脱机技术（虚拟设备）
库函数实现的 I/O系统调用
 I/O系统调用通常先是库函数调用：库函数与调用程序连接在一起，被嵌入在运行时装入内存的二进制程序中。
 count=write(fd，buffer，nbytes)；
非库函数实现的 I/O系统调用
 spooling系统

## 驱动调度技术

存储设备的物理结构
顺序存取存储设备：存取信息时，只能按存储单元的位置，顺序地一个接一个地进行存取的存储器。严格依赖信息的物理位置进行定位和读写的存储设备；
具有存储容量大、稳定可靠、卷可装卸和便于保存等优点。
直接存取存储设备：每个物理记录有确定的位置和唯一的地址。信息存取所需的时间几乎不依赖于此信息的位置。
磁盘是一种直接(随机)存取存储设备。
访问磁盘记录参数：柱面号、磁头号、块号
盘片（Platter ）　　
磁盘最基本的组成部分是由坚硬金属材料制成的涂以磁性介质的盘片，不同容量硬盘的盘片数不等。每个盘片有两面，都可记录信息。
磁道 (Tracks)
盘片表面以盘片中心为圆心，不同半径的同心圆称为磁道。
扇区(Sectors)
盘片被分成许多扇形的区域，每个区域叫一个扇区，硬盘每个扇区可存储512字节信息。FAT32模式下，每个扇区的容量为4KB。每个扇区的大小相当于一个盘块。
磁头(Heads)
每个盘片的每一面都有一个读写头（read-write head），用于读取相应盘面的数据。习惯用磁头号来区分。

磁盘的类型
固定头磁盘
每条磁道上都有一个读/写磁头，所有的磁头被装入一个磁臂
通过这些磁头可以访问所有磁道，并进行并行读写
主要用于大容量磁盘
移动头磁盘
每个盘面仅有一个磁头，被装入一个磁臂中
为能访问盘面上的所有磁道，该磁头必须移动以进行寻道
只能串行读/写，致使I/O速度较慢
结构简单，广泛应用中、小型磁盘，微机上的硬盘和软盘，都采用移动磁头结构
寻道时间（seek time）Ts
将磁头从当前位置移到指定磁道所经历的时间。一般为2－30毫秒，平均约为10毫秒。 Ts=m*n+s
s：磁盘的启动时间,大约3ms；
m：每移动一条磁道所经历的时间，对一般磁盘：m＝0.3ms，对高速磁盘：m<＝0.1ms；
n：移动的磁道数目；
传输时间Tt
数据从磁盘读出，或向磁盘写数据所经历的时间，约为零点几个毫秒,可以忽略不计。
                 Tt＝b/rN
b：读写的字节数
r：磁盘以秒计的旋转速度
N：一条磁道上的字节数
访问时间
          Ta=Ts+Tr+Tt=(m*n+s)+1/2r+b/rN

设备独立性
用户不指定特定设备，指定逻辑设备，使得用户作业和物理设备独立开来，
通过其它途径建立逻辑设备和物理设备之间对应关系，这种特性为“设备独立性”。
好处--用户与物理的外围设备无关，系统增减或变更外围设备时程序不必修改；易于对付输入输出设备的故障。
设备独立性带来以下两方面的好处：
设备分配时的灵活性
当进程以逻辑设备名请求某类设备时，如果一台设备已经分配给其它进程或正在检修，此时系统可以将其它几台相同的空闲设备中的任一台分配给该进程，只有当此类设备全部被分配完时，进程才会被阻塞。
易于实现I/O重定向
用于I/O操作的设备可以更换，重定向即而不必改变应用程序。
设备独立性软件
    为了实现设备的独立性，必须在驱动程序之上设置一层软件，称为设备独立性软件，其主要功能有以下两个方面：

 1. 执行所有设备的公有操作
 2.向用户层（或文件层）软件提供统一的接口
逻辑设备表
    为了实现逻辑设备名到物理设备名的映射，系统必须设置一张逻辑设备表LUT（Logical Unit Table），能够将应用程序中所使用的逻辑设备名映射为物理设备名，并提供该设备驱动程序的入口地址。

## 虚拟设备

SPOOLing技术：是用一类物理设备模拟另一类物理设备的技术，是使独占设备变成共享设备的一种技术。
虚拟设备的主要条件
硬件方面：有大容量磁盘，中断机构和通道装置支撑，使CPU与外设设备可以并行工作的能力；
软件方面：多道程序设计技术，合理分配处理器，实现联机的外围设备同时操作

设计和实现
“井”是用作缓冲的存储区域，采用井的技术能调节供求之间的矛盾，消除人工干预带来的损失。
“预输入程序”
“缓输出程序”
“井管理程序”
输入井中作业状态
输入状态：
收容收态：
执行状态：
完成状态：
SPOOLING数据结构
作业表：登记进入系统的所有作业的作业名、状态、预输入表位置等信息。
预输入表：每个用户作业有一张用来登记该作业的各个文件的情况，包括设备类、信息长度及存放位置等。
缓输出表：每个用户作业拥有一张包括作业名、作业状态、文件名、设备类、数据起始位置、数据当前位置等。
井文件空间的管理(1)
连接方式：输入的信息被组织成连接文件，这种方式的优点是数据信息可以不连续存放，文件空间利用率高
井文件空间的管理(2)
计算方式：假定磁盘井文件空间，每个磁道存放100个80字节记录，每张卡片为80个字节，若每个柱面有20个磁道，则一个柱面可存放2000张卡片信息。第n张卡片信息被存放在：
                磁道号＝卡片号n /100
                记录号＝（卡片号n）% 100
用卡片号n除以100的整数和余数部分分别为其存放的磁道号和记录号。

SPOOLing系统的特点

提高I/O的速度

将独占设备改造为共享设备

实现虚拟设备的功能
